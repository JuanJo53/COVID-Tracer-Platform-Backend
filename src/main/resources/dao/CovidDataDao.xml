<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bo.ucb.edu.covid_tracer_platform_backend.dao.CovidDataDao">
    <insert id="createCovidData" parameterType="bo.ucb.edu.covid_tracer_platform_backend.model.CovidData">
        INSERT INTO `covid_data`(`covid_data_id`, `country_id`, `department_id`, `municipality_id`, `confirmed`, `cumulative_confirmed`, `deaths`, `cumulative_deaths`, `recovered`, `cumulative_recovered`, `date`, `status`, `tx_id`, `tx_host`, `tx_user_id`, `tx_date`)
                         VALUES (null,#{countryId},#{departmentId},#{municipalityId},#{confirmed},#{cumulativeConfirmed},#{deaths},#{cumulativeDeaths},#{recovered},#{cumulativeRecovered},#{date},1,#{transaction.txId},#{transaction.txHost},#{transaction.txUserId},#{transaction.txDate})
    </insert>

    <select id="lastDateDepartment" resultType="java.util.Date">
        SELECT MAX(date)
        FROM covid_data
        WHERE
            department_id = #{departmentId}
            and municipality_id is NULL
            and status = 1
    </select>

    <select id="lastDateMunicipality" resultType="java.util.Date">
        SELECT MAX(a.date)
        FROM covid_data a, municipality b
        WHERE
            b.municipality = #{municipality}
            and b.municipality_id = a.municipality_id
            and b.department_id = a.department_id
            and a.status = 1
    </select>

    <select id="getCovidDataTotalByDepartment" resultType="java.lang.Integer">
        select COUNT(covid_data_id)
        from covid_data
        where
            department_id = #{departmentId}
            and municipality_id is NULL
            and status = 1
    </select>

    <select id="covidDataHistoricListByDepartment" resultMap="covidDataMap">
        SELECT
            covid_data_id as id,
            date as date,
            confirmed as confirmed,
            deaths as deaths,
            recovered as recovered
        FROM covid_data
        WHERE
            department_id = #{departmentId}
            and municipality_id is NULL
            and status = 1
        LIMIT #{size} OFFSET #{page}
    </select>

    <select id="covidDataCumulativeListByDepartment" resultMap="covidDataMap">
        SELECT
            covid_data_id as id,
            date as date,
            cumulative_confirmed as confirmed,
            cumulative_deaths as deaths,
            cumulative_recovered as recovered
        FROM covid_data
        WHERE
            department_id = #{departmentId}
          and municipality_id is NULL
          and status = 1
            LIMIT #{size} OFFSET #{page}
    </select>

    <resultMap id="covidDataMap" type="bo.ucb.edu.covid_tracer_platform_backend.dto.CovidDataListDepartment">
        <result column="id" property="id"/>
        <result column="date" property="date"/>
        <result column="confirmed" property="confirmed"/>
        <result column="deaths" property="deaths"/>
        <result column="recovered" property="recovered"/>
    </resultMap>




    <select id="listDepartament" resultMap="DepartamentDataMap">
        SELECT
            b.department_id as departmentId,
            b.iso as iso,
            b.department as department,
            MAX(a.cumulative_confirmed) as confirmed,
            MAX(a.cumulative_deaths) as deaths,
            MAX(a.cumulative_recovered) as recovered,
            b.longitude as longitude,
            b.latitude as latitude
        FROM covid_data a, department b, country c
        WHERE
            c.iso = #{countryISO}
          and c.country_id=b.country_id
          and b.department_id=a.department_id
          and b.status = 1
          GROUP BY b.department;
    </select>

    <resultMap id="DepartamentDataMap" type="bo.ucb.edu.covid_tracer_platform_backend.dto.DepartmentListRequest">
        <result column="departmentId" property="departmentId"/>
        <result column="iso" property="iso"/>
        <result column="department" property="department"/>
        <result column="confirmed" property="confirmed"/>
        <result column="deaths" property="deaths"/>
        <result column="recovered" property="recovered"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
    </resultMap>





    <select id="getDepartament" resultType="bo.ucb.edu.covid_tracer_platform_backend.dto.DepartmentListRequest">
        SELECT
            b.department_id as departmentId,
            b.iso as iso,
            b.department as department,
            MAX(a.cumulative_confirmed) as confirmed,
            MAX(a.cumulative_deaths) as deaths,
            MAX(a.cumulative_recovered) as recovered,
            b.longitude as longitude,
            b.latitude as latitude
        FROM covid_data a, department b, country c
        WHERE
            c.iso = #{countryISO}
            and b.iso=#{isoDepartment}
          and c.country_id=b.country_id
          and b.department_id=a.department_id
          and b.status = 1
          GROUP BY b.department;
    </select>


    <select id="listMunicipality" resultMap="MunicipalityDataMap">
          SELECT
            b.municipality as municipality,
            a.cumulative_confirmed as confirmed,
            a.cumulative_deaths as deaths,
            a.cumulative_recovered as recovered,
            b.longitude as longitude,
            b.latitude as latitude
        FROM covid_data a, municipality b, country c, department d
        WHERE
            c.iso =  #{countryISO}
            and d.iso=#{isoDepartment}
            AND b.municipality_id=a.municipality_id
          and c.country_id=d.country_id
          and d.department_id=a.department_id
          and d.status = 1
    </select>

    <resultMap id="MunicipalityDataMap" type="bo.ucb.edu.covid_tracer_platform_backend.dto.MunicipalityListRequet">
        <result column="municipality" property="municipality"/>
        <result column="confirmed" property="confirmed"/>
        <result column="deaths" property="deaths"/>
        <result column="recovered" property="recovered"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
    </resultMap>
</mapper>
